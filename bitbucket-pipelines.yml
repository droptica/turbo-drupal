definitions:
  services:
    mysql:
      image: mysql:8.0
      environment:
        MYSQL_DATABASE: 'drupal'
        MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
        MYSQL_USER: 'drupal'
        MYSQL_PASSWORD: 'drupal'

pipelines:
  pull-requests:
    '**':
      - step:
          name: Build and Test Drupal
          image: drupal:10-apache
          services:
            - mysql
          caches:
            - composer
          script:
            # Instalacja niezbędnych narzędzi i rozszerzeń PHP
            - apt-get update && apt-get install -y git unzip imagemagick libmagickwand-dev
            - pecl install imagick
            - docker-php-ext-enable imagick

            # Instalacja Composera
            - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
            
            # Instalacja zależności projektu
            - composer install --no-dev --ignore-platform-req=ext-*
            
            # Instalacja Drush
            - composer require drush/drush
            
            # Konfiguracja Drupala
            - mkdir -p web/sites/default/files
            - chmod -R 777 web/sites/default/files
            - cp web/sites/default/default.settings.php web/sites/default/settings.php
            - chmod 777 web/sites/default/settings.php
            
            # Konfiguracja bazy danych
            #- echo "\$databases['default']['default'] = ['driver' => 'mysql','database' => 'drupal','username' => 'root','password' => 'root','host' => 'mysql'];" >> web/sites/default/settings.php
            
            # Instalacja Drupala
            - cat .bitbucket/settings.local.php.txt >> ./web/sites/default/settings.php
            - vendor/bin/drush site:install --account-name=admin --account-pass=admin -y
            
            # Sprawdzenie statusu
            - vendor/bin/drush status
            - update_branch_name="update/${date}"
            - git checkout -B "${update_branch_name}"
            - git push --set-upstream origin "${update_branch_name}"
          services:
            - mysql
          artifacts:
            - "**"

      - parallel:
          steps:
            - step:
                name: CodeSniffer
                image: droptica/phpcs
                script:
                  - phpcs --standard=./phpcs.xml ./web/modules/custom ./web/themes/custom

            - step:
                name: PHPStan
                image: droptica/phpstan
                script:
                  - ln -s "$(pwd)" /opt/project
                  - phpstan analyse -c ./phpstan.neon --no-progress
